# =============================================================================
# Codespaces Prebuild Workflow
# =============================================================================
# This workflow pre-builds the Codespace to reduce startup time.
# It caches Maven dependencies and npm packages.
# =============================================================================

name: Codespaces Prebuild

on:
  push:
    branches: [main]
    paths:
      - '.devcontainer/**'
      - 'forestech-microservices/**/pom.xml'
      - 'forestech-ui/package.json'
      - 'forestech-ui/package-lock.json'
  pull_request:
    branches: [main]
    paths:
      - '.devcontainer/**'
  workflow_dispatch:
    inputs:
      rebuild_all:
        description: 'Force rebuild all services'
        required: false
        default: 'false'
        type: boolean

jobs:
  prebuild:
    name: Pre-download Dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # Java/Maven Setup
      # -----------------------------------------------------------------------
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Download Maven dependencies - Config Server
        run: |
          if [ -f "forestech-microservices/infrastructure/config-server/pom.xml" ]; then
            cd forestech-microservices/infrastructure/config-server
            mvn dependency:go-offline -B -q || true
          fi

      - name: Download Maven dependencies - Services
        run: |
          for service in forestech-microservices/services/*/; do
            if [ -f "$service/pom.xml" ]; then
              echo "ðŸ“¦ Processing $(basename $service)..."
              cd "$service"
              mvn dependency:go-offline -B -q || true
              cd - > /dev/null
            fi
          done

      # -----------------------------------------------------------------------
      # Node.js/npm Setup
      # -----------------------------------------------------------------------
      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: forestech-ui/package-lock.json

      - name: Install npm dependencies
        run: |
          cd forestech-ui
          npm ci

      # -----------------------------------------------------------------------
      # Optional: Build services (if force rebuild requested)
      # -----------------------------------------------------------------------
      - name: Build all services
        if: ${{ github.event.inputs.rebuild_all == 'true' }}
        run: |
          for service in forestech-microservices/services/*/; do
            if [ -f "$service/pom.xml" ]; then
              echo "ðŸ”¨ Building $(basename $service)..."
              cd "$service"
              mvn clean package -DskipTests -B -q || true
              cd - > /dev/null
            fi
          done

      # -----------------------------------------------------------------------
      # Summary
      # -----------------------------------------------------------------------
      - name: Generate summary
        run: |
          echo "## ðŸ“¦ Prebuild Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Maven Dependencies Cached" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          for service in forestech-microservices/services/*/; do
            name=$(basename $service)
            echo "| $name | âœ… |" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### npm Dependencies" >> $GITHUB_STEP_SUMMARY
          echo "| Package | Version |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| react | $(cat forestech-ui/package.json | jq -r '.dependencies.react') |" >> $GITHUB_STEP_SUMMARY
          echo "| @mui/material | $(cat forestech-ui/package.json | jq -r '.dependencies["@mui/material"]') |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Prebuild completed at $(date)" >> $GITHUB_STEP_SUMMARY
